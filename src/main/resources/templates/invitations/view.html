<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ëª¨ë°”ì¼ ì²­ì²©ì¥</title>

  <!-- ëª¨ë°”ì¼ ëŒ€ì‘ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- CSRF ì„¸ì…˜ ê¶Œí•œ ì¸ì¦ ì¸ê°€ -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <!-- ì¸ë„¤ì¼ìš© -->
  <meta property="og:type" content="website">
  <meta property="og:title"
        th:content="${invitation.groomName} + ' â™¥ ' + ${invitation.brideName} + ' ê²°í˜¼ì‹ ì´ˆëŒ€ì¥'"/>
  <meta property="og:description"
        th:content="${invitation.weddingDate} + ' Â· ' + ${invitation.hallName}"/>

  <meta property="og:image"
        th:if="${ogImageUrl != null}"
        th:content="${ogImageUrl}"/>

  <meta property="og:url"
        th:content="@{|/invitation/${code}|}"/>

  <meta name="twitter:card" content="summary_large_image">

  <style>
    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        padding: 0;
        background: linear-gradient(180deg, #f3eee7, #fdfaf5);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
        color: #222;
    }

    .invite-container {
        max-width: 520px;
        margin: 0 auto;
        background: #fdfaf5;
        padding: 0 0 40px;
        min-height: 100vh;
        box-shadow: 0 6px 24px rgba(0,0,0,0.06);
        border-radius: 16px;
        overflow: hidden;
    }

    /* ìƒë‹¨ íƒ€ì´í‹€ */
    .page-title-wrap {
        padding: 16px 18px 8px;
        text-align: center;
    }

    h1#title {
        font-size: 18px;
        margin: 0 0 4px;
        letter-spacing: 0.08em;
        color: #5b3b2a;
    }

    .title-sub {
        font-size: 11px;
        color: #a27c5b;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        margin: 0;
    }

    /* ë©”ì¸ íˆì–´ë¡œ ì˜ì—­ (ì‚¬ì§„ + ê°„ëµ ì˜ˆì‹ì •ë³´) */
    .hero-container {
        margin-top: 10px;
    }

    .hero-image-wrap {
        width: 100%;
        overflow: hidden;
    }

    #mainImage {
        width: 100%;
        max-height: 420px;
        object-fit: cover;
        display: block;
    }

    .hero-info-card {
        background: #fdf7ef;
        border-top: 1px solid rgba(0,0,0,0.03);
        padding: 18px 18px 20px;
        text-align: center;
        position: relative;
    }

    .hero-names-row {
        font-size: 15px;
        color: #40312a;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 26px;
        margin-bottom: 10px;
    }

    .hero-names-row span {
        white-space: nowrap;
    }

    .hero-date-center {
        font-size: 13px;
        color: #8b5a3c;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        margin-top: 6px;
    }

    .hero-hall {
        margin-top: 10px;
        font-size: 13px;
        color: #4a3b33;
    }

    .hero-divider-line {
        width: 60%;
        height: 1px;
        background: #e6d4c5;
        margin: 10px auto 0;
    }

    /* ë³¸ë¬¸ ë‚´ìš© íŒ¨ë”© */
    .content-inner {
        padding: 18px 18px 32px;
    }

    .section-title {
        font-weight: 600;
        margin-top: 22px;
        margin-bottom: 8px;
        font-size: 14px;
        color: #8b5a3c;
        letter-spacing: 0.04em;
    }

    .meta-row {
        font-size: 14px;
        line-height: 1.7;
        white-space: pre-line;
        word-break: break-word;
        margin: 0;
    }

    /* ì¸ì‚¬ë§ / ì—°ë½ì²˜ ì¹´ë“œ */
    .soft-card {
        background: #f8f1ea;
        border-radius: 14px;
        padding: 12px 12px 10px;
        border: 1px solid #f0e0ce;
        margin-top: 6px;
    }

    .soft-card .meta-row {
        font-size: 13px;
    }

    .contact-card {
        background: #f9f4ec;
        border-radius: 14px;
        padding: 10px 12px 8px;
        border: 1px dashed #e3d2bd;
        margin-top: 6px;
        font-size: 13px;
    }

    /* ì—°ë½ì²˜/ê³„ì¢Œ ì¤„ + ë³µì‚¬ ë²„íŠ¼ */
    .contact-line {
        font-size: 13px;
        line-height: 1.7;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        margin: 2px 0;
    }
    .contact-line-text {
        white-space: pre-line;
        word-break: break-word;
        flex: 1;
    }
    .copy-btn {
        flex-shrink: 0;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #e0d0c0;
        background: #fff;
        font-size: 11px;
        cursor: pointer;
        color: #7b4b30;
    }
    .copy-btn:hover {
        background: #f5eee7;
    }

    /* ì˜ˆì‹ ì¼ì • ìº˜ë¦°ë” ì¹´ë“œ */
    .calendar-card {
        background: #faf3ea;
        border-radius: 18px;
        padding: 18px 18px 16px;
        border: 1px solid #eddccc;
        margin-top: 6px;
        text-align: center;
    }
    .calendar-header-date {
        font-size: 18px;
        color: #5b3b2a;
        margin-bottom: 4px;
    }
    .calendar-header-time {
        font-size: 13px;
        color: #8b5a3c;
        margin-bottom: 14px;
    }
    .calendar-divider {
        height: 1px;
        background: #e6d4c5;
        margin: 6px auto 14px;
        width: 70%;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        font-size: 12px;
        margin-bottom: 12px;
    }
    .calendar-day-name {
        color: #b48b6d;
        font-weight: 500;
        padding: 2px 0 4px;
    }
    .calendar-day {
        height: 26px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .calendar-day span {
        display: inline-block;
        padding: 4px 0;
        width: 24px;
        text-align: center;
        border-radius: 999px;
    }
    .calendar-day.empty span {
        opacity: 0;
    }
    .calendar-day.selected span {
        background: #d8b08c;
        color: #fff;
    }
    .calendar-footer-text {
        font-size: 12px;
        color: #a07064;
        margin-top: 4px;
    }

    /* ì§€ë„ ì¹´ë“œ */
    .map-card {
        border-radius: 18px;
        overflow: hidden;
        margin-top: 10px;
        background: #f7f0e4;
        border: 1px solid #ead8c3;
    }

    .map-card-header {
        padding: 14px 16px 10px;
        text-align: center;
    }

    .map-card-header h2 {
        font-size: 15px;
        margin: 0 0 6px;
        color: #7b4b30;
    }

    .map-card-header p {
        font-size: 12px;
        color: #555;
        margin: 0;
        white-space: pre-line;
        word-break: break-word;
    }

    .map-buttons {
        display: flex;
        gap: 8px;
        padding: 10px 10px 12px;
        justify-content: center;
        background: #fbf7f2;
        border-top: 1px solid #f0e3d4;
    }

    .map-btn {
        padding: 7px 10px;
        font-size: 12px;
        background: #fff;
        border-radius: 999px;
        border: 1px solid #e5d7c9;
        text-decoration: none;
        color: #333;
        flex: 1;
        text-align: center;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }

    .map-btn:hover {
        background: #f5eee7;
    }

    /* 'ì˜¤ì‹œëŠ” ë°©ë²•' ì•ˆë‚´ ì¹´ë“œ */
    .transport-card {
        margin-top: 10px;
        background: #f9f4ec;
        border-radius: 14px;
        padding: 12px 14px 10px;
        border: 1px solid #f0e0ce;
        font-size: 13px;
        line-height: 1.7;
        white-space: pre-line;
        word-break: break-word;
    }

    /* ê°¤ëŸ¬ë¦¬ ì„¹ì…˜ */
    #galleryWrapper {
        margin-top: 8px;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }

    .gallery-item img {
        width: 100%;
        display: block;
        border-radius: 10px;
        object-fit: cover;
        aspect-ratio: 3 / 4;
        background: #eee;
    }

    #galleryMoreBtn {
        margin: 12px auto 0;
        display: none;
        padding: 7px 14px;
        border-radius: 999px;
        border: 1px solid #e5d7c9;
        background: #fbf7f2;
        font-size: 13px;
        cursor: pointer;
        color: #7b4b30;
    }

    #galleryMoreBtn:hover {
        background: #f2e6d7;
    }

    /* ë°©ëª…ë¡ í¼ */
    #guestName,
    #guestMessage {
        width: 100%;
        padding: 9px;
        margin-bottom: 8px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-size: 14px;
        background: #fff;
    }

    #guestMessage {
        resize: none;
        height: 80px;
    }

    #guestSubmitBtn {
        width: 100%;
        padding: 11px;
        margin-top: 4px;
        border-radius: 12px;
        border: none;
        background: #111827;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
    }

    #guestSubmitBtn:hover {
        background: #0f172a;
    }

    /* ë°©ëª…ë¡ ë¦¬ìŠ¤íŠ¸ */
    .guestbook-wrapper {
        margin-top: 6px;
        border-radius: 14px;
        background: #fbf7f2;
        border: 1px solid #efe2d4;
        padding: 8px 10px;
    }

    #guestbookList > div {
        padding: 8px 0;
        font-size: 13px;
        border-bottom: 1px solid #f0e0d2;
    }

    #guestbookList > div:last-child {
        border-bottom: none;
    }

    #guestbookList strong {
        font-weight: 600;
        color: #5b3b2a;
    }

    .time {
        color: #999;
        font-size: 11px;
        margin-left: 6px;
    }

    hr {
        border: none;
        border-top: 1px solid #e3dfd8;
        margin: 24px 0 18px;
    }

    .footer-note {
        margin-top: 20px;
        text-align: center;
        font-size: 11px;
        color: #a08a77;
    }
  </style>

  <!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a682e7903e1e2a73122644b71bb093a0&libraries=services"></script>
</head>

<body th:attr="data-code=${code}">
<div class="invite-container">

  <!-- ì œëª© ì˜ì—­ -->
  <div class="page-title-wrap">
    <h1 id="title">ì´ˆëŒ€ì¥ ë¡œë”© ì¤‘...</h1>
    <p class="title-sub">WE INVITE YOU TO OUR WEDDING DAY</p>
  </div>

  <!-- ë©”ì¸ íˆì–´ë¡œ (ì‚¬ì§„ + í•œ ì¤„ ì˜ˆì‹ì •ë³´) -->
  <div class="hero-container">
    <div class="hero-image-wrap">
<!--      <img id="mainImage" alt="ë©”ì¸ ì´ë¯¸ì§€"-->
<!--           th:src="@{|/admin/invitations/${code}/images/main|}">-->
<!--      <img id="mainImage" alt="ë©”ì¸ ì´ë¯¸ì§€"-->
<!--           th:src="@{|/api/v1/invitations/${code}/images/main|}">-->
      <img src="" id="mainImage" alt="ë©”ì¸ ì´ë¯¸ì§€">
    </div>
    <div class="hero-info-card">
      <div class="hero-names-row">
        <span id="heroGroomName"></span>
        <span>â”‚</span>
        <span id="heroBrideName"></span>
      </div>
      <div class="hero-date-center" id="heroDateText"></div>
      <div class="hero-hall" id="heroHallText"></div>
      <div class="hero-divider-line"></div>
    </div>
  </div>

  <!-- ë³¸ë¬¸ -->
  <div class="content-inner" id="content" style="display:none;">

    <!-- ì˜ˆì‹ ì¼ì • (ìº˜ë¦°ë”) -->
    <p class="section-title">ì˜ˆì‹ ì¼ì •</p>
    <div id="calendarCard" class="calendar-card">
      <div class="calendar-header-date" id="calendarHeaderDate"></div>
      <div class="calendar-header-time" id="calendarHeaderTime"></div>
      <div class="calendar-divider"></div>
      <div class="calendar-grid" id="weddingCalendar"></div>
      <div class="calendar-footer-text" id="calendarFooterText"></div>
    </div>

    <!-- ì¸ì‚¬ë§ -->
    <p class="section-title">ì¸ì‚¬ë§</p>
    <div class="soft-card">
      <p class="meta-row" id="message"></p>
    </div>

    <!-- ì—°ë½ì²˜ / ê³„ì¢Œ -->
    <p class="section-title">ì—°ë½ì²˜ / ê³„ì¢Œ</p>
    <div class="contact-card">
      <div id="contactInfo"></div>
    </div>

    <!-- ì˜¤ì‹œëŠ” ê¸¸ (ì§€ë„ + ì£¼ì†Œ ê²€ìƒ‰) -->
    <p class="section-title">ì˜¤ì‹œëŠ” ê¸¸</p>
    <div id="mapSection" class="map-card">
      <div class="map-card-header">
        <h2 id="mapHallName"></h2>
        <p id="mapAddress"></p>
      </div>
      <div id="mapCanvas" style="width:100%; height:240px;"></div>

      <div class="map-buttons">
        <a id="naverMapBtn" class="map-btn" target="_blank">ë„¤ì´ë²„ ì§€ë„</a>
        <a id="kakaoMapBtn" class="map-btn" target="_blank">ì¹´ì¹´ì˜¤ ì§€ë„</a>
      </div>
    </div>

    <!-- (ì˜µì…˜) ì˜¤ì‹œëŠ” ë°©ë²• í…ìŠ¤íŠ¸ -->
    <div id="transportInfoCard" class="transport-card" style="display:none;"></div>

    <!-- ê°¤ëŸ¬ë¦¬ -->
    <p class="section-title">ê°¤ëŸ¬ë¦¬</p>
    <div id="galleryWrapper" style="display:none;">
      <div id="galleryGrid" class="gallery-grid"></div>
      <button id="galleryMoreBtn">ì‚¬ì§„ ë” ë³´ê¸°</button>
    </div>

    <hr>

    <!-- ë°©ëª…ë¡ -->
    <p class="section-title">âœ ì¶•í•˜ ë©”ì‹œì§€</p>
    <input id="guestName" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
    <textarea id="guestMessage" placeholder="ë”°ëœ»í•œ ì¶•í•˜ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>
    <button id="guestSubmitBtn">ë“±ë¡</button>

    <p class="section-title">ğŸ‰ ë°©ëª…ë¡</p>
    <div class="guestbook-wrapper">
      <div id="guestbookList"></div>
    </div>

    <p class="footer-note">
      ë‘ ì‚¬ëŒì˜ ìƒˆë¡œìš´ ì‹œì‘ì„ ì¶•ë³µí•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.
    </p>

  </div>

  <div id="error" style="text-align:center; color:red; display:none;"></div>
</div>

<script>
  function formatTimeAgo(timeString) {
      if (!timeString) return "";
      const now = new Date();
      const t = new Date(timeString);
      const diff = (now - t) / 1000;
      if (diff < 60) return "ë°©ê¸ˆ ì „";
      if (diff < 3600) return Math.floor(diff/60) + "ë¶„ ì „";
      if (diff < 86400) return Math.floor(diff/3600) + "ì‹œê°„ ì „";
      return t.toLocaleString("ko-KR").slice(0, -3);
  }

  async function loadGuestbooks(code) {
      const res = await fetch(`/api/v1/invitations/${code}/guestbook`);
      if (!res.ok) return;
      const list = await res.json();

      const el = document.getElementById("guestbookList");
      el.innerHTML = "";

      if (list.length === 0) {
          el.innerHTML = "<p style='font-size:13px; color:#777; margin:6px 0;'>ì²« ì¶•í•˜ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>";
          return;
      }

      list.forEach(item => {
          const div = document.createElement("div");
          div.innerHTML = `<strong>${item.guestName}</strong>
                           <span class="time">${formatTimeAgo(item.createdAt)}</span>
                           <br>${item.message}`;
          el.appendChild(div);
      });
  }

  async function addGuestbook(code) {
      const nameEl = document.getElementById("guestName");
      const msgEl = document.getElementById("guestMessage");

      const name = nameEl.value.trim();
      const message = msgEl.value.trim();

      if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      if (!message) return alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

      const csrfToken = document.querySelector('meta[name="_csrf"]').content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

      const res = await fetch(`/api/v1/invitations/${code}/guestbook`, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              [csrfHeader]: csrfToken
          },
          body: JSON.stringify({ guestName: name, message: message })
      });

      if (res.ok) {
          nameEl.value = "";
          msgEl.value = "";
          loadGuestbooks(code);
      } else {
          alert("ë“±ë¡ ì‹¤íŒ¨");
      }
  }

  async function loadGalleryImages(code) {
  const res = await fetch(`/api/v1/invitations/${code}/images`);
  if (!res.ok) return;

  const urls = await res.json();
  console.log("Gallery URL:", urls);

  if (!urls.length) return;

  // ì—¬ê¸°ì„œ ë©”ì¸ ì´ë¯¸ì§€ë„ ê°™ì´ ì§€ì •
  const mainImageEl = document.getElementById("mainImage");
  if (mainImageEl) {
      mainImageEl.src = urls[0];  // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ëŒ€í‘œ ì´ë¯¸ì§€ë¡œ
  }

  const wrapper = document.getElementById("galleryWrapper");
  wrapper.style.display = "block";

  const grid = document.getElementById("galleryGrid");
  const moreBtn = document.getElementById("galleryMoreBtn");

  const MAX_INITIAL = 6;

  urls.forEach((url, idx) => {
      const box = document.createElement("div");
      box.className = "gallery-item";

      const img = document.createElement("img");
      img.src = url;              // ì¸ë„¤ì¼ë„ ê°™ì€ url ì‚¬ìš©
      img.alt = `gallery-${idx}`;

      box.appendChild(img);

      if (idx >= MAX_INITIAL) {
          box.style.display = "none";
          box.classList.add("hidden-gallery-item");
      }

      grid.appendChild(box);
  });

  if (urls.length > MAX_INITIAL) {
      moreBtn.style.display = "inline-flex";
      moreBtn.addEventListener("click", () => {
          document.querySelectorAll(".hidden-gallery-item")
              .forEach(el => el.style.display = "block");
          moreBtn.style.display = "none";
      });
  } else {
      moreBtn.style.display = "none";
  }
}


  // ---- ì—°ë½ì²˜ / ê³„ì¢Œ ê´€ë ¨ í—¬í¼ ----
  function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text)
              .then(() => alert("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."))
              .catch(() => alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
      } else {
          const temp = document.createElement("textarea");
          temp.value = text;
          document.body.appendChild(temp);
          temp.select();
          try {
              document.execCommand("copy");
              alert("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
              alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
          document.body.removeChild(temp);
      }
  }

  function renderContactInfo(raw) {
      const container = document.getElementById("contactInfo");
      container.innerHTML = "";

      if (!raw) return;

      const lines = raw.split(/\r?\n/);

      lines.forEach(line => {
          const trimmed = line.trim();
          if (!trimmed) return;

          const lineDiv = document.createElement("div");
          lineDiv.className = "contact-line";

          const textSpan = document.createElement("div");
          textSpan.className = "contact-line-text";
          textSpan.textContent = trimmed;
          lineDiv.appendChild(textSpan);

          const digits = trimmed.replace(/\D/g, "");
          const isAccountLine = digits.length >= 10;

          if (isAccountLine) {
              const btn = document.createElement("button");
              btn.type = "button";
              btn.className = "copy-btn";
              btn.textContent = "ë³µì‚¬";
              btn.addEventListener("click", () => copyToClipboard(digits));
              lineDiv.appendChild(btn);
          }

          container.appendChild(lineDiv);
      });
  }

  // ---- ì˜ˆì‹ ì¼ì • ìº˜ë¦°ë” ë Œë”ë§ ----
  function renderCalendar(weddingDateStr, weddingTimeStr, groomName, brideName) {
      const card = document.getElementById("calendarCard");
      const headerDate = document.getElementById("calendarHeaderDate");
      const headerTime = document.getElementById("calendarHeaderTime");
      const grid = document.getElementById("weddingCalendar");
      const footer = document.getElementById("calendarFooterText");

      if (!weddingDateStr) {
          card.style.display = "none";
          return;
      }

      const parts = weddingDateStr.split("-");
      if (parts.length !== 3) {
          card.style.display = "none";
          return;
      }

      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const day = parseInt(parts[2], 10);

      if (isNaN(year) || isNaN(month) || isNaN(day)) {
          card.style.display = "none";
          return;
      }

      const date = new Date(year, month - 1, day);
      const yoilNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
      const yoil = yoilNames[date.getDay()];

      // í—¤ë” í…ìŠ¤íŠ¸
      const ymd = `${year}.${String(month).padStart(2, "0")}.${String(day).padStart(2, "0")}`;
      headerDate.textContent = ymd;
      headerTime.textContent = weddingTimeStr
          ? `${yoil}ìš”ì¼ ${weddingTimeStr}`
          : `${yoil}ìš”ì¼`;

      // ìº˜ë¦°ë” ë³¸ë¬¸
      grid.innerHTML = "";

      // ìš”ì¼ í—¤ë”
      ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(name => {
          const div = document.createElement("div");
          div.className = "calendar-day-name";
          div.textContent = name;
          grid.appendChild(div);
      });

      const firstDay = new Date(year, month - 1, 1).getDay();
      const lastDate = new Date(year, month, 0).getDate();

      // ì•ìª½ ë¹ˆ ì¹¸
      for (let i = 0; i < firstDay; i++) {
          const div = document.createElement("div");
          div.className = "calendar-day empty";
          const span = document.createElement("span");
          span.textContent = "";
          div.appendChild(span);
          grid.appendChild(div);
      }

      // ë‚ ì§œ ì±„ìš°ê¸°
      for (let d = 1; d <= lastDate; d++) {
          const div = document.createElement("div");
          div.className = "calendar-day" + (d === day ? " selected" : "");
          const span = document.createElement("span");
          span.textContent = d;
          div.appendChild(span);
          grid.appendChild(div);
      }

      // D-Day ë¬¸êµ¬
      const today = new Date();
      const todayMid = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const ddayDate = new Date(year, month - 1, day);
      const diffMs = todayMid - ddayDate;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      const groom = groomName || "ì‹ ë‘";
      const bride = brideName || "ì‹ ë¶€";

      if (diffDays === 0) {
          footer.textContent = `${groom} â™¥ ${bride}ì˜ ê²°í˜¼ì‹ì´ ì˜¤ëŠ˜ì…ë‹ˆë‹¤.`;
      } else if (diffDays > 0) {
          footer.textContent = `${groom} â™¥ ${bride}ì˜ ê²°í˜¼ì‹ì´ ${diffDays}ì¼ ì§€ë‚¬ìŠµë‹ˆë‹¤.`;
      } else {
          footer.textContent = `${groom} â™¥ ${bride}ì˜ ê²°í˜¼ì‹ì´ ${Math.abs(diffDays)}ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;
      }
  }

  document.addEventListener("DOMContentLoaded", async () => {
      const code = document.body.getAttribute("data-code");

      const response = await fetch(`/api/v1/invitations/${code}`);

      if (!response.ok) {
          document.getElementById("title").innerText = "ì´ˆëŒ€ì¥ ì¡°íšŒ ì‹¤íŒ¨";
          document.getElementById("error").style.display = "block";
          return;
      }

      const data = await response.json();

      // ì œëª©
      document.getElementById("title").innerText = data.title || "Wedding Invitation";

      // íˆì–´ë¡œ ì˜ì—­
      document.getElementById("heroGroomName").innerText = data.groomName || "";
      document.getElementById("heroBrideName").innerText = data.brideName || "";

      const dateStr = data.weddingDate || "";
      const timeStr = data.weddingTime || "";

      let heroDateText = "";
      if (dateStr && timeStr) {
          heroDateText = `${dateStr} Â· ${timeStr}`;
      } else if (dateStr) {
          heroDateText = dateStr;
      } else if (timeStr) {
          heroDateText = timeStr;
      }
      document.getElementById("heroDateText").innerText = heroDateText;
      document.getElementById("heroHallText").innerText = data.hallName || "";

      // ì¸ì‚¬ë§
      const messageEl = document.getElementById("message");
      messageEl.innerHTML  = (data.message || "").replace(/\n/g, "<br>");

      // ì—°ë½ì²˜/ê³„ì¢Œ (ì¤„ë°”ê¿ˆ + ê³„ì¢Œ ë³µì‚¬ ë²„íŠ¼)
      renderContactInfo(data.contactInfo || "");

      // ì˜ˆì‹ ì¼ì • ìº˜ë¦°ë”
      renderCalendar(data.weddingDate, data.weddingTime, data.groomName, data.brideName);

      // ì˜¤ì‹œëŠ” ë°©ë²• í…ìŠ¤íŠ¸
      if (data.transportInfo) {
          const tCard = document.getElementById("transportInfoCard");
          tCard.style.display = "block";
          tCard.textContent = data.transportInfo;
      }

      document.getElementById("content").style.display = "block";

      // ì§€ë„ ì…‹ì—… (ì£¼ì†Œë¡œ ê²€ìƒ‰ URL êµ¬ì„±)
      const mapSection   = document.getElementById("mapSection");
      const mapHallName  = document.getElementById("mapHallName");
      const mapAddress   = document.getElementById("mapAddress");
      const mapCanvas    = document.getElementById("mapCanvas");
      const naverMapBtn  = document.getElementById("naverMapBtn");
      const kakaoMapBtn  = document.getElementById("kakaoMapBtn");

      const safeAddress = (data.address || "").trim();
      const safeMapUrl  = (data.mapUrl || "").trim();

      mapHallName.innerText = data.hallName || "";
      mapAddress.innerText  = safeAddress || "ì£¼ì†Œ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";

      if (!safeAddress && !safeMapUrl) {
          if (mapSection) {
              mapSection.style.display = "none";
          }
      } else {
          const hasAddress = !!safeAddress;
          const encAddr    = hasAddress ? encodeURIComponent(safeAddress) : "";

          const kakaoSearchUrl = hasAddress ? `https://map.kakao.com/?q=${encAddr}` : "";
          const naverSearchUrl = hasAddress ? `https://map.naver.com/v5/search/${encAddr}` : "";

          function setupMapButton(btn, url) {
              if (!btn) return;
              if (url) {
                  btn.href = url;
                  btn.style.display = "inline-flex";
              } else {
                  btn.style.display = "none";
              }
          }

          // ì£¼ì†Œë¡œ ì§€ë„ ê²€ìƒ‰ ê°€ëŠ¥í•œ ë²„íŠ¼ë“¤
          setupMapButton(kakaoMapBtn, safeMapUrl || kakaoSearchUrl);
          setupMapButton(naverMapBtn, naverSearchUrl);

          // ì¹´ì¹´ì˜¤ JS SDK ì§€ë„
          if (mapCanvas && hasAddress && window.kakao && kakao.maps) {
              const mapOption = {
                  center: new kakao.maps.LatLng(37.566826, 126.9786567),
                  level: 3
              };
              const map = new kakao.maps.Map(mapCanvas, mapOption);
              const geocoder = new kakao.maps.services.Geocoder();

              geocoder.addressSearch(safeAddress, function(result, status) {
                  if (status === kakao.maps.services.Status.OK) {
                      const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                      new kakao.maps.Marker({
                          map: map,
                          position: coords
                      });
                      map.setCenter(coords);
                  }
              });
          }
      }

      // ë©”ì¸ ì´ë¯¸ì§€ API URL ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
      if (data.mainImageUrl) {
          document.getElementById("mainImage").src = data.mainImageUrl;
      }

      await loadGuestbooks(code);
      await loadGalleryImages(code);

      document.getElementById("guestSubmitBtn")
          .addEventListener("click", () => addGuestbook(code));
  });
</script>

</body>
</html>
